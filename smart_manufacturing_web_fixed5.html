<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能制造视觉检测系统 (修复版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFFB',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        info: '#86909C',
                        dark: '#1D2129',
                        light: '#F2F3F5'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
            .backdrop-blur-sm { backdrop-filter: blur(4px); }
            .scrollbar-hide::-webkit-scrollbar { display: none; }
            .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
            .btn-hover { @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5; }
            .card-hover { @apply transition-all duration-300 hover:shadow-xl hover:border-primary; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-primary text-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-industry text-2xl"></i>
                <h1 class="text-xl font-bold">智能制造视觉检测系统</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="opencv-status" class="bg-yellow-500 text-xs px-2 py-1 rounded">OpenCV 初始化中...</span>
                <span id="current-time" class="text-sm font-medium"></span>
            </div>
        </div>
    </header>

    <main class="flex-1 container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                    <div class="relative aspect-video bg-gray-900">
                        <video id="video" class="absolute inset-0 w-full h-full object-cover" style="opacity: 0; z-index: 1;" playsinline muted></video>
                        <canvas id="canvasOutput" class="absolute inset-0 w-full h-full object-contain" style="z-index: 10;"></canvas>
                        
                        <div class="absolute top-4 left-4 bg-black/70 text-white text-xs px-2 py-1 rounded-md backdrop-blur-sm" style="z-index: 20;">
                            <span id="camera-status" class="flex items-center">
                                <i id="camera-indicator" class="fa fa-circle text-danger mr-1"></i>
                                <span id="camera-text">摄像头未连接</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t border-gray-200">
                        <div class="flex flex-wrap gap-3">
                            <button id="open-camera" class="flex-1 bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-md btn-hover" disabled>
                                <i class="fa fa-video-camera mr-2"></i>打开摄像头
                            </button>
                            <button id="close-camera" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md btn-hover" disabled>
                                <i class="fa fa-times mr-2"></i>关闭摄像头
                            </button>
                            <button id="load-image" class="flex-1 bg-secondary hover:bg-secondary/90 text-white py-2 px-4 rounded-md btn-hover">
                                <i class="fa fa-upload mr-2"></i>加载图片
                            </button>
                            <input type="file" id="image-upload" accept="image/*" class="hidden">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-4 card-hover">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-bar-chart text-primary mr-2"></i>实时识别结果
                    </h2>
                    <div id="detection-result" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="border border-gray-200 rounded-lg p-3 text-center">
                            <div class="text-sm text-gray-500">检测状态</div>
                            <div id="detection-status" class="font-semibold text-danger">停止</div>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-3 text-center">
                            <div class="text-sm text-gray-500">识别颜色</div>
                            <div id="color-value" class="font-semibold">--</div>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-3 text-center">
                            <div class="text-sm text-gray-500">轮廓面积</div>
                            <div id="area-value" class="font-semibold">0</div>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-3 text-center">
                            <div class="text-sm text-gray-500">FPS</div>
                            <div id="fps-value" class="font-semibold">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                 <div class="bg-white rounded-lg shadow-md p-4 card-hover">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-tachometer text-primary mr-2"></i>系统状态
                    </h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">OpenCV引擎</span>
                            <span id="system-opencv-status" class="text-warning">加载中...</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">串口连接</span>
                            <span id="serial-status" class="text-danger">未连接</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-4 card-hover">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-magic text-primary mr-2"></i>智能操作
                    </h2>
                    <div class="space-y-3">
                        <button class="w-full bg-secondary hover:bg-secondary/90 text-white py-2 px-4 rounded-md opacity-50 cursor-not-allowed">
                            <i class="fa fa-refresh mr-2"></i>自动校准 (未连接)
                        </button>
                        <button class="w-full bg-warning hover:bg-warning/90 text-white py-2 px-4 rounded-md opacity-50 cursor-not-allowed">
                            <i class="fa fa-reply-all mr-2"></i>电机复位 (未连接)
                        </button>
                        <button class="w-full bg-success hover:bg-success/90 text-white py-2 px-4 rounded-md opacity-50 cursor-not-allowed">
                            <i class="fa fa-cog mr-2"></i>冲压操作 (未连接)
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-4 card-hover">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-file-text text-primary mr-2"></i>系统日志
                    </h2>
                    <div id="system-log" class="h-48 overflow-y-auto bg-gray-50 p-3 rounded-md text-sm text-gray-700 scrollbar-hide font-mono"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // === 全局变量 ===
        let videoElement = document.getElementById('video');
        let canvasOutput = document.getElementById('canvasOutput');
        let canvasContext = canvasOutput.getContext('2d');
        let stream = null;
        let isCameraOpen = false;
        let isOpenCvReady = false;
        
        // OpenCV 变量 
        let src = null;
        let dst = null;
        let hsv = null;
        let mask = null;
        let maskRed1 = null;
        let maskRed2 = null;
        let maskBlue = null;
        let contours = null;
        let hierarchy = null;
        let cap = null;
        
        let lowRed1, highRed1, lowRed2, highRed2, lowBlue, highBlue;

        // === 1. 初始化 ===
        function onOpenCvReady() {
            document.getElementById('opencv-status').textContent = "OpenCV 就绪";
            document.getElementById('opencv-status').className = "bg-green-500 text-white text-xs px-2 py-1 rounded";
            document.getElementById('system-opencv-status').textContent = "正常运行";
            document.getElementById('system-opencv-status').className = "text-success";
            
            document.getElementById('open-camera').disabled = false;
            isOpenCvReady = true;
            addLog("OpenCV.js 加载完成，引擎就绪。");
        }

        window.onload = function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            document.getElementById('open-camera').addEventListener('click', startCamera);
            document.getElementById('close-camera').addEventListener('click', stopCamera);
            // 绑定图片加载按钮
            document.getElementById('load-image').addEventListener('click', function() {
                document.getElementById('image-upload').click();
            });
            document.getElementById('image-upload').addEventListener('change', handleImageUpload);
        };

        function updateCurrentTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString();
        }

        function addLog(msg) {
            let log = document.getElementById('system-log');
            let div = document.createElement('div');
            div.className = "mb-1 border-b border-gray-100 pb-1";
            div.innerHTML = `<span class="text-gray-400">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        // === 2. 摄像头控制 ===
        function startCamera() {
            if (!isOpenCvReady) {
                addLog("OpenCV 未就绪，请等待...");
                return;
            }
            
            addLog("正在请求摄像头权限...");
            
            // 尝试获取高清流
            const constraints = {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'environment'
                },
                audio: false
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(s) {
                    stream = s;
                    videoElement.srcObject = stream;
                    videoElement.play();
                    
                    isCameraOpen = true;
                    document.getElementById('open-camera').disabled = true;
                    document.getElementById('close-camera').disabled = false;
                    
                    updateStatus(true);
                    addLog("摄像头权限已获取，视频流开始...");

                    // 关键：等待元数据加载，确保有宽高度
                    videoElement.onloadedmetadata = function() {
                        addLog(`摄像头分辨率: ${videoElement.videoWidth}x${videoElement.videoHeight}`);
                        videoElement.width = videoElement.videoWidth;
                        videoElement.height = videoElement.videoHeight;
                        
                        // 初始化 OpenCV
                        initOpenCVObjects();
                    };
                })
                .catch(function(err) {
                    addLog("打开摄像头失败: " + err);
                    alert("无法打开摄像头，请检查权限或HTTPS连接。");
                });
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            isCameraOpen = false;
            document.getElementById('open-camera').disabled = false;
            document.getElementById('close-camera').disabled = true;
            updateStatus(false);
            addLog("摄像头已关闭");
            
            // 清理内存
            cleanUpOpenCV();
            
            // 清空 Canvas
            canvasContext.clearRect(0, 0, canvasOutput.width, canvasOutput.height);
        }

        function updateStatus(active) {
            let indicator = document.getElementById('camera-indicator');
            let text = document.getElementById('camera-text');
            let dStatus = document.getElementById('detection-status');
            
            if (active) {
                indicator.className = "fa fa-circle text-success mr-1";
                text.textContent = "摄像头运行中";
                dStatus.textContent = "运行中";
                dStatus.className = "font-semibold text-success";
            } else {
                indicator.className = "fa fa-circle text-danger mr-1";
                text.textContent = "摄像头关闭";
                dStatus.textContent = "停止";
                dStatus.className = "font-semibold text-danger";
            }
        }
        
        // 处理图片上传（简单的预览功能）
        function handleImageUpload(event) {
            let file = event.target.files[0];
            if(file) {
                addLog("已加载图片：" + file.name);
                let url = URL.createObjectURL(file);
                let img = new Image();
                img.onload = function() {
                    canvasOutput.width = img.width;
                    canvasOutput.height = img.height;
                    canvasContext.drawImage(img, 0, 0);
                    // 这里未来可以加上静态图片识别逻辑
                };
                img.src = url;
            }
        }

        // === 3. 核心视觉算法 ===
        function initOpenCVObjects() {
            try {
                let width = videoElement.videoWidth;
                let height = videoElement.videoHeight;
                
                if (width === 0 || height === 0) {
                    addLog("错误：视频尺寸为0，重新尝试...");
                    setTimeout(initOpenCVObjects, 500);
                    return;
                }
                
                canvasOutput.width = width;
                canvasOutput.height = height;

                // 初始化矩阵
                if(src) src.delete(); // 防止重复初始化内存泄漏
                src = new cv.Mat(height, width, cv.CV_8UC4);
                dst = new cv.Mat(height, width, cv.CV_8UC3);
                hsv = new cv.Mat(height, width, cv.CV_8UC3);
                mask = new cv.Mat();
                maskRed1 = new cv.Mat();
                maskRed2 = new cv.Mat();
                maskBlue = new cv.Mat();
                contours = new cv.MatVector();
                hierarchy = new cv.Mat();
                
                // 阈值 (与 Python 保持一致)
                // Red 1
                lowRed1 = new cv.Mat(height, width, cv.CV_8UC3, [0, 50, 50, 0]);
                highRed1 = new cv.Mat(height, width, cv.CV_8UC3, [10, 255, 255, 0]);
                // Red 2
                lowRed2 = new cv.Mat(height, width, cv.CV_8UC3, [170, 50, 50, 0]);
                highRed2 = new cv.Mat(height, width, cv.CV_8UC3, [180, 255, 255, 0]);
                // Blue
                lowBlue = new cv.Mat(height, width, cv.CV_8UC3, [100, 50, 50, 0]);
                highBlue = new cv.Mat(height, width, cv.CV_8UC3, [125, 255, 255, 0]);

                // 创建 VideoCapture
                cap = new cv.VideoCapture(videoElement);
                
                addLog("OpenCV 矩阵初始化完成，开始循环处理...");
                requestAnimationFrame(processVideoFrame);
            } catch(e) {
                addLog("初始化出错: " + e);
            }
        }

        function cleanUpOpenCV() {
            try {
                if(src) src.delete(); src = null;
                if(dst) dst.delete(); dst = null;
                if(hsv) hsv.delete(); hsv = null;
                if(mask) mask.delete(); mask = null;
                if(maskRed1) maskRed1.delete(); maskRed1 = null;
                if(maskRed2) maskRed2.delete(); maskRed2 = null;
                if(maskBlue) maskBlue.delete(); maskBlue = null;
                if(contours) contours.delete(); contours = null;
                if(hierarchy) hierarchy.delete(); hierarchy = null;
                if(lowRed1) lowRed1.delete(); lowRed1 = null;
                if(highRed1) highRed1.delete(); highRed1 = null;
                if(lowRed2) lowRed2.delete(); lowRed2 = null;
                if(highRed2) highRed2.delete(); highRed2 = null;
                if(lowBlue) lowBlue.delete(); lowBlue = null;
                if(highBlue) highBlue.delete(); highBlue = null;
            } catch(e) {}
        }

        let lastTime = Date.now();
        let frameCount = 0;

        function processVideoFrame() {
            if (!isCameraOpen || !src) return;

            try {
                let begin = Date.now();

                // 1. 读取帧
                cap.read(src);

                // 2. 转换颜色空间
                cv.cvtColor(src, dst, cv.COLOR_RGBA2RGB);
                cv.cvtColor(dst, hsv, cv.COLOR_RGB2HSV);

                // 3. 颜色检测
                // 红
                cv.inRange(hsv, lowRed1, highRed1, maskRed1);
                cv.inRange(hsv, lowRed2, highRed2, maskRed2);
                cv.bitwise_or(maskRed1, maskRed2, mask);
                // 蓝
                cv.inRange(hsv, lowBlue, highBlue, maskBlue);

                let colorDetected = "--";
                let maxArea = 0;
                let colorLabelColor = "text-gray-500";
                
                // 4. 查找轮廓 (必须每次循环清理 hierarchy, 但 contours 变量复用)
                // 找蓝色
                // 注意：JS中 findContours 可能会抛出异常如果 mat 为空
                cv.findContours(maskBlue, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                let blueFound = false;
                for (let i = 0; i < contours.size(); ++i) {
                    let area = cv.contourArea(contours.get(i));
                    if (area > 1800) {
                        blueFound = true;
                        maxArea = Math.max(maxArea, area);
                    }
                }
                
                if (blueFound) {
                    colorDetected = "蓝色";
                    colorLabelColor = "text-primary";
                    // 绘制轮廓 (Img, Contours, Idx, Color, Thickness)
                    cv.drawContours(dst, contours, -1, new cv.Scalar(0, 0, 255), 3); 
                } else {
                    // 找红色
                    cv.findContours(mask, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                    let redFound = false;
                    for (let i = 0; i < contours.size(); ++i) {
                        let area = cv.contourArea(contours.get(i));
                        if (area > 1800) {
                            redFound = true;
                            maxArea = Math.max(maxArea, area);
                        }
                    }
                    
                    if (redFound) {
                        colorDetected = "红色";
                        colorLabelColor = "text-danger";
                        cv.drawContours(dst, contours, -1, new cv.Scalar(255, 0, 0), 3); 
                    }
                }

                // 5. 显示结果
                cv.imshow('canvasOutput', dst);

                // 6. 更新UI
                document.getElementById('color-value').textContent = colorDetected;
                document.getElementById('color-value').className = "font-semibold " + colorLabelColor;
                document.getElementById('area-value').textContent = Math.round(maxArea);

                // FPS 计算
                frameCount++;
                if (Date.now() - lastTime >= 1000) {
                    document.getElementById('fps-value').textContent = frameCount;
                    frameCount = 0;
                    lastTime = Date.now();
                }

                // 循环
                let delay = 1000/30 - (Date.now() - begin);
                setTimeout(() => requestAnimationFrame(processVideoFrame), delay);

            } catch (err) {
                // 如果出错（通常是刚开始视频流不稳定），重试
                // console.error(err);
                requestAnimationFrame(processVideoFrame);
            }
        }
    </script>
</body>
</html>
